<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>REMS</title>
  <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;600&family=Roboto:wght@300;500&family=Orbitron:wght@500&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
  <style>
    :root {
      --primary: #2E7D32;
      --secondary: #81C784;
      --accent: #FFD54F;
      --tertiary: #17a2b8;
      --bg: #f4faf5;
      --card-bg: #ffffff;
      --text: #333333;
      --font: 'Quicksand', sans-serif;
      --shadow: 0 4px 6px rgba(0,0,0,0.1);
      --gradient-start: #34b3a0;
      --gradient-mid: #ffcc33;
      --gradient-end: #28a745;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    /* Premium Dark Mode Styles */
    body.dark-mode {
      background: #0f1115;
      color: #e4e6eb;
      transition: background-color 0.3s ease, color 0.3s ease;
    }

    .sidebar.dark-mode {
      background: #1b1f27;
      box-shadow: 0 4px 6px rgba(0,0,0,0.3);
    }

    .header.dark-mode {
      background: #1b1f27;
      box-shadow: 0 4px 6px rgba(0,0,0,0.3);
    }

    .card.dark-mode {
      background: #1b1f27;
      box-shadow: 0 4px 6px rgba(0,0,0,0.3);
    }

    .stat-item.dark-mode {
      background: #1b1f27;
      box-shadow: 0 4px 6px rgba(0,0,0,0.3);
    }

    .stat-item.dark-mode h3,
    .stat-item.dark-mode .comparison-matrix {
      color: #e4e6eb;
    }

    .stat-item.dark-mode .value {
      color: #4CAF50;
    }

    .stat-item.dark-mode i {
      color: #4CAF50;
      background: rgba(76, 175, 80, 0.1);
    }

    .nav-item.dark-mode:hover, .nav-item.dark-mode.active {
      background: #252932;
      color: #4CAF50;
      box-shadow: 0 2px 8px rgba(76, 175, 80, 0.2);
    }

    .nav-item.dark-mode i {
      color: #e4e6eb;
    }

    .nav-item.dark-mode:hover i, .nav-item.dark-mode.active i {
      color: #4CAF50;
    }

    .status-card.dark-mode {
      background: #1b1f27;
    }

    .status-card.dark-mode h4 {
      color: #4CAF50;
    }

    .status-card.dark-mode p {
      color: #e4e6eb;
    }

    .efficiency-meter.dark-mode {
      background: #252932;
    }

    .progress-bar.dark-mode {
      background: #2a2f3a;
    }

    .efficiency-value.dark-mode {
      color: #e4e6eb;
    }

    .system-info.dark-mode {
      background: #1b1f27;
      color: #e4e6eb;
      border: 1px solid #252932;
    }
    
    .system-info.dark-mode h4 {
      color: #4CAF50;
    }
    
    .system-info.dark-mode p {
      color: #e4e6eb;
    }

    .analytics-card.dark-mode {
      background: #1b1f27;
      color: #e4e6eb;
    }
  
    .analytics-card.dark-mode h3 {
      color: #4CAF50;
    }
  
    .analytics-card.dark-mode p {
      color: #e4e6eb;
    }

    .control-btn.dark-mode {
      background: #252932;
    }

    .control-btn.dark-mode.active {
      background: #2E7D32;
      box-shadow: 0 4px 12px rgba(46, 125, 50, 0.4);
    }

    .action-btn.dark-mode {
      background: #252932;
      color: #e4e6eb;
    }

    .action-btn.dark-mode:hover {
      background: #2E7D32;
      color: #ffffff;
    }

    .notification-dropdown.dark-mode {
      background: #1b1f27;
      box-shadow: 0 8px 16px rgba(0,0,0,0.4);
    }

    .dropdown-header.dark-mode {
      color: #4CAF50;
      border-bottom: 1px solid #252932;
    }

    .alert.dark-mode.warning {
      background: rgba(245, 124, 0, 0.15);
      color: #ff9800;
      border-left: 3px solid #ff9800;
    }

    .alert.dark-mode.success {
      background: rgba(46, 125, 50, 0.15);
      color: #4CAF50;
      border-left: 3px solid #4CAF50;
    }

    .alert.dark-mode.info {
      background: rgba(33, 150, 243, 0.15);
      color: #2196F3;
      border-left: 3px solid #2196F3;
    }

    .alert.dark-mode.error {
      background: rgba(244, 67, 54, 0.15);
      color: #f44336;
      border-left: 3px solid #f44336;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: var(--font);
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
    }

    .dashboard {
      display: grid;
      grid-template-columns: 280px 1fr;
      grid-template-rows: 80px 1fr;
      min-height: 100vh;
      gap: 24px;
      padding: 24px;
      max-width: 1920px;
      margin: 0 auto;
    }

    body {
      font-family: var(--font);
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
    }

    .dashboard {
      display: grid;
      grid-template-columns: 280px 1fr;
      grid-template-rows: 80px 1fr;
      min-height: 100vh;
      gap: 24px;
      padding: 24px;
      max-width: 1920px;
      margin: 0 auto;
    }

    /* Sidebar Styles */
    .sidebar {
      grid-row: 1 / -1;
      background: var(--card-bg);
      padding: 2rem;
      border-radius: 20px;
      box-shadow: var(--shadow);
      display: flex;
      flex-direction: column;
      gap: 0.7rem;
      position: sticky;
      top: 24px;
      height: calc(100vh - 48px);
    }

    .sidebar-logo {
      display: flex;
      align-items: center;
      gap: 1rem;
      padding-bottom: 1.5rem;
      border-bottom: 2px solid var(--bg);
    }

    .sidebar-logo i {
      font-size: 2.2rem;
      color: var(--primary);
      background: var(--bg);
      padding: 12px;
      border-radius: 12px;
    }

    .sidebar-logo h2 {
      font-size: 1.8rem;
      font-weight: 600;
      color: var(--primary);
    }

    .nav-menu {
      list-style: none;
      display: flex;
      flex-direction: column;
      gap: 0.8rem;
    }

    .nav-item {
      padding: 1rem 1.2rem;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 1.2rem;
      font-weight: 500;
    }

    .nav-item:hover, .nav-item.active {
      background: #e8f5e9;
      color: #4CAF50;
      box-shadow: 0 2px 8px rgba(76, 175, 80, 0.15);
    }

    .nav-item:hover i, .nav-item.active i {
      color: #4CAF50;
    }

    .nav-item i {
      font-size: 1.4rem;
      color: var(--text);
      transition: color 0.3s ease;
    }

    .system-info {
      margin-top: auto;
      padding: 1.5rem;
      background: var(--bg);
      border-radius: 12px;
    }

    .system-info h4 {
      color: var(--primary);
      margin-bottom: 1rem;
      font-size: 1.2rem;
      font-weight: 600;
    }
    
    .system-info p {
      margin-bottom: 0.8rem;
      font-size: 1rem;
    }

    /* Header Styles */
    .header {
      grid-column: 2;
      grid-row: 1;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 2rem;
      background: var(--card-bg);
      border-radius: 20px;
      box-shadow: var(--shadow);
    }

    .header h1 {
      font-size: 2rem;
      color: var(--primary);
      font-weight: 600;
    }

    .header-notification {
      position: relative;
    }

    .notification-btn {
      background: none;
      border: none;
      position: relative;
      cursor: pointer;
      font-size: 1.5rem;
      color: var(--primary);
      padding: 0.5rem;
      border-radius: 50%;
      transition: background 0.2s;
    }

    .notification-btn:hover {
      background: var(--bg);
    }

    .notification-badge {
      position: absolute;
      top: 2px;
      right: 2px;
      background: #f44336;
      color: #fff;
      font-size: 0.7rem;
      font-weight: bold;
      border-radius: 50%;
      padding: 2px 6px;
      min-width: 18px;
      text-align: center;
      z-index: 2;
    }

    .notification-dropdown {
      position: absolute;
      right: 0;
      top: 2.5rem;
      width: 320px;
      background: var(--card-bg);
      box-shadow: var(--shadow);
      border-radius: 12px;
      z-index: 100;
      max-height: 350px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      min-width: 220px;
    }

    .dropdown-header {
      font-weight: 600;
      color: var(--primary);
      padding: 1rem 1rem 0.5rem 1rem;
      border-bottom: 1px solid var(--bg);
      font-size: 1.1rem;
    }

    .dropdown-alerts {
      padding: 0.5rem 1rem 1rem 1rem;
      max-height: 250px;
      overflow-y: auto;
    }

    .dropdown-alerts .alert {
      margin-bottom: 0.5rem;
      font-size: 0.95rem;
    }

    .user-info {
      display: flex;
      align-items: center;
      gap: 1.2rem;
      padding: 0.8rem 1.2rem;
      background: var(--bg);
      border-radius: 12px;
      transition: all 0.3s ease;
    }

    .user-info:hover {
      cursor: pointer;
    }

    .user-info i {
      font-size: 1.6rem;
      color: var(--primary);
    }

    .user-info span {
      font-weight: 500;
      color: var(--text);
    }

    /* Main Content */
    .main-content {
      grid-column: 2;
      grid-row: 2;
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      grid-template-rows: auto minmax(400px, auto) minmax(350px, auto);
      gap: 24px;
    }

    /* Stats Grid */
    .stats-grid {
      grid-column: 1 / -1;
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 24px;
    }

    .stat-item {
      background: var(--card-bg);
      border-radius: 20px;
      padding: 1.4rem 1.2rem;
      box-shadow: var(--shadow);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.7rem;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .stat-item::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 4px;
      background: linear-gradient(to right, var(--gradient-start), var(--gradient-end));
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .stat-item:hover {
      box-shadow: 0 8px 15px rgba(0,0,0,0.1);
    }

    .stat-trend {
      display: flex;
      align-items: center;
      gap: 0.4rem;
      font-size: 0.85rem;
      padding: 0.25rem 0.6rem;
      border-radius: 8px;
      background: var(--bg);
    }

    .stat-trend.up {
      color: #4CAF50;
    }

    .stat-trend.down {
      color: #f44336;
    }

    .stat-trend.stable {
      color: #FF9800;
    }

    .quick-actions {
      grid-column: 1 / -1;
      display: flex;
      justify-content: center;
      gap: 1rem;
      margin-top: 2rem;
      padding: 1rem;
      background: var(--card-bg);
      border-radius: 20px;
      box-shadow: var(--shadow);
    }

    .action-btn {
      padding: 0.8rem 1.5rem;
      border: none;
      border-radius: 12px;
      background: var(--bg);
      color: var(--text);
      cursor: pointer;
      font-family: var(--font);
      font-weight: 600;
      font-size: 0.9rem;
      
      display: flex;
      align-items: center;
      gap: 0.8rem;
    }

    .action-btn:hover {
      background: var(--primary);
      color: white;
    }

    .action-btn i {
      font-size: 1.1rem;
    }

    .comparison-matrix {
      font-size: 0.9rem;
      color: var(--text);
      opacity: 0.8;
      text-align: center;
      margin-top: 0.5rem;
    }

    .stat-item i {
      font-size: 2rem;
      color: var(--primary);
      background: var(--bg);
      padding: 0.8rem;
      border-radius: 15px;
    }

    .stat-item h3 {
      font-size: 1.1rem;
      color: var(--text);
      font-weight: 500;
    }

    .stat-item .value {
      font-size: 2rem;
      font-weight: bold;
      color: var(--primary);
      font-family: 'Orbitron', sans-serif;
    }

    /* Chart Cards */
    .chart-card {
      grid-column: 1 / 4;
      background: var(--card-bg);
      border-radius: 20px;
      padding: 1.8rem;
      box-shadow: var(--shadow);
    }

    .chart-card h3 {
      font-size: 1.5rem;
      color: var(--primary);
      margin-bottom: 1.5rem;
      font-weight: 600;
    }

    /* System Status */
    .system-status {
      grid-column: 4;
      background: var(--card-bg);
      border-radius: 20px;
      padding: 1.8rem;
      box-shadow: var(--shadow);
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
    }

    .controls {
      display: grid;
      gap: 1rem;
    }

    .control-btn {
      padding: 1.2rem;
      border: none;
      border-radius: 12px;
      background: var(--secondary);
      color: white;
      cursor: pointer;
      font-family: var(--font);
      font-weight: 600;
      font-size: 1rem;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 1rem;
      width: 100%;
      position: relative;
      padding-right: 3rem;
      opacity: 0.6;
    }

    .control-btn i {
      font-size: 1.4rem;
      min-width: 24px;
      text-align: center;
      margin-right: 0.5rem;
    }

    .control-btn span:not(.status-indicator) {
      flex: 1;
      text-align: left;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .status-indicator {
      display: inline-block;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.5);
      position: absolute;
      right: 1.2rem;
      top: 50%;
      transition: all 0.3s ease;
      margin-left: auto;
    }

    .status-indicator.active {
      background: #fff;
      box-shadow: 0 0 8px rgba(255, 255, 255, 0.8);
    }

    .control-btn.active {
      background: var(--primary);
      box-shadow: 0 4px 16px rgba(46, 125, 50, 0.5), 0 0 20px rgba(46, 125, 50, 0.3);
      opacity: 1 !important;
      transform: scale(1.02);
    }

    .control-btn:hover:not(:disabled):not(.active) {
      background: var(--secondary);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(129, 199, 132, 0.3);
      opacity: 0.8;
    }

    .control-btn:hover:not(:disabled).active {
      background: var(--primary);
      transform: translateY(-2px) scale(1.02);
      box-shadow: 0 6px 20px rgba(46, 125, 50, 0.5), 0 0 25px rgba(46, 125, 50, 0.4);
    }

    .control-btn:disabled {
      opacity: 0.4;
      cursor: not-allowed;
      transform: none;
      background: var(--secondary);
    }

    .control-btn:disabled:hover {
      transform: none;
      box-shadow: none;
      background: var(--secondary);
    }

    .status-info {
      margin-top: auto;
      padding-top: 1.5rem;
      border-top: 3px solid var(--bg);
    }

    .status-info h4 {
      color: var(--primary);
      margin-bottom: 1rem;
      font-size: 1.2rem;
      font-weight: 600;
    }

    .status-info p {
      margin-bottom: 0.8rem;
      font-size: 1rem;
      color: var(--text);
    }

    #lastUpdate {
      color: var (--primary);
      font-weight: 600;
    }

    /* Responsive Design */
    @media (max-width: 1400px) {
      .dashboard {
        grid-template-columns: 240px 1fr;
        padding: 20px;
        gap: 20px;
      }

      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    @media (max-width: 1024px) {
      .dashboard {
        grid-template-columns: 1fr;
      }
      
      .sidebar {
        display: none;
      }
      
      .header,
      .main-content {
        grid-column: 1;
      }

      .system-status {
        grid-column: 1 / -1;
      }

      .chart-card {
        grid-column: 1 / -1;
      }

      .profile-content.active {
        grid-template-columns: 1fr;
      }

      .system-info-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    @media (max-width: 768px) {
      .stats-grid {
        grid-template-columns: 1fr;
      }

      .header {
        padding: 1rem;
      }

      .header h1 {
        font-size: 1.5rem;
      }

      .controls {
        grid-template-columns: 1fr;
      }

      .system-info-grid {
        grid-template-columns: 1fr;
      }

      .user-info-card h3 {
        font-size: 1.5rem;
      }

      .user-avatar {
        width: 100px;
        height: 100px;
        font-size: 2.5rem;
      }
    }

    /* Add new styles */
    .efficiency-meter {
      margin: 1.5rem 0;
      padding: 1.5rem;
      background: var(--bg);
      border-radius: 12px;
    }

    .efficiency-meter h4 {
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--primary);
      margin-bottom: 1rem;
    }

    .progress-bar {
      height: 20px;
      background: #e0e0e0;
      border-radius: 10px;
      position: relative;
      margin-top: 10px;
      overflow: hidden;
    }

    .progress {
      height: 100%;
      background: linear-gradient(to right, var(--gradient-start), var(--gradient-end));
      width: 0%;
      transition: width 0.5s ease;
    }

    .efficiency-value {
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--text);
      font-weight: 600;
      font-size: 0.9rem;
    }

    .alerts {
      margin-top: 1rem;
      max-height: 100px;
      overflow-y: auto;
    }

    .alert {
      padding: 0.5rem;
      margin-bottom: 0.5rem;
      border-radius: 6px;
      font-size: 0.9rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .alert.warning {
      background: #fff3e0;
      color: #f57c00;
    }

    .alert.success {
      background: #e8f5e9;
      color: #2e7d32;
    }

    /* Add styles for system status in sidebar */
    .status-card {
      margin-top: auto;
      padding: 1.5rem;
      background: var(--bg);
      border-radius: 12px;
      margin-bottom: 1rem;
    }

    .status-card h4 {
      color: var(--primary);
      margin-bottom: 1rem;
      font-size: 1.2rem;
      font-weight: 600;
    }

    .status-card p {
      margin-bottom: 0.8rem;
      font-size: 1rem;
      color: var(--text);
      opacity: 0.9;
    }

    .status-card #lastUpdate {
      color: var(--primary);
      font-weight: 600;
    }

    /* Add Analytics page styles */
    .analytics-content {
      display: none;
      grid-column: 2;
      grid-row: 2;
      gap: 24px;
    }

    .analytics-content.active {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
    }

    .analytics-card {
      background: var(--card-bg);
      border-radius: 20px;
      padding: 1.8rem;
      box-shadow: var(--shadow);
    }

    .analytics-card.full-width {
      grid-column: 1 / -1;
    }

    .analytics-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
    }

    .time-filter {
      display: flex;
      gap: 1rem;
    }

    .time-filter button {
      padding: 0.5rem 1rem;
      border: none;
      border-radius: 8px;
      background: var(--bg);
      color: var(--text);
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .time-filter button.active {
      background: var(--primary);
      color: white;
    }

    .system-status-indicator {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.4rem 0.8rem;
      border-radius: 8px;
      font-size: 0.85rem;
      font-weight: 600;
      margin-bottom: 0.5rem;
    }

    .system-status-indicator.online {
      background: rgba(76, 175, 80, 0.1);
      color: #4CAF50;
    }

    .system-status-indicator.offline {
      background: rgba(244, 67, 54, 0.1);
      color: #f44336;
    }

    .system-status-indicator i {
      font-size: 0.7rem;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .alert.info {
      background: #e3f2fd;
      color: #1976d2;
      border-left: 3px solid #1976d2;
    }

    .alert.error {
      background: #ffebee;
      color: #c62828;
      border-left: 3px solid #c62828;
    }

    .notification-item {
      padding: 0.75rem;
      margin-bottom: 0.5rem;
      border-radius: 8px;
      display: flex;
      align-items: flex-start;
      gap: 0.75rem;
      font-size: 0.9rem;
      transition: background 0.2s;
    }

    .notification-item:hover {
      background: rgba(0,0,0,0.05);
    }

    .notification-item.dark-mode:hover {
      background: rgba(255,255,255,0.05);
    }

    .notification-icon {
      font-size: 1.1rem;
      margin-top: 0.1rem;
      flex-shrink: 0;
    }

    .notification-content {
      flex: 1;
    }

    .notification-time {
      font-size: 0.75rem;
      opacity: 0.7;
      margin-top: 0.25rem;
    }

    .notification-remove {
      background: none;
      border: none;
      color: inherit;
      cursor: pointer;
      opacity: 0.6;
      font-size: 1.2rem;
      padding: 0;
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    .notification-remove:hover {
      opacity: 1;
    }

    /* Profile and Settings Pages */
    .profile-content, .settings-content, .notifications-content {
      display: none;
      grid-column: 2;
      grid-row: 2;
      gap: 24px;
      min-height: calc(100vh - 120px);
    }

    .profile-content.active {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      grid-auto-rows: 1fr;
      align-items: stretch;
      gap: 24px;
    }

    .settings-content.active {
      display: grid;
      grid-template-columns: 1fr;
    }

    .notifications-content.active {
      display: grid;
      grid-template-columns: 1fr;
    }

    .profile-card, .settings-card, .notifications-card {
      background: var(--card-bg);
      border-radius: 20px;
      padding: 2.5rem;
      box-shadow: var(--shadow);
      display: flex;
      flex-direction: column;
    }

    .profile-card.full-width {
      grid-column: 1 / -1;
    }

    .user-avatar {
      width: 140px;
      height: 140px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 3.5rem;
      color: white;
      margin: 0 auto 2rem;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    .user-info-card {
      text-align: center;
      padding: 2rem;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      height: 100%;
      min-height: 500px;
    }

    .user-info-card h3 {
      color: var(--primary);
      margin-bottom: 0.75rem;
      font-size: 2rem;
      font-weight: 600;
    }

    .user-info-card .role {
      color: var(--text);
      opacity: 0.8;
      margin-bottom: 1.5rem;
      font-size: 1.1rem;
      font-weight: 500;
    }

    .user-info-card .email {
      color: var(--text);
      margin-bottom: 0.75rem;
      font-size: 1.05rem;
    }

    .user-info-card .phone {
      color: var(--text);
      opacity: 0.8;
      margin-bottom: 0.75rem;
      font-size: 1.05rem;
    }

    .user-info-card .location {
      color: var(--text);
      opacity: 0.8;
      margin-bottom: 1.5rem;
      font-size: 1.05rem;
    }

    .user-info-card .info-row {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.75rem;
      margin-bottom: 0.75rem;
      font-size: 1rem;
      color: var(--text);
      opacity: 0.85;
      text-align: left;
    }

    .user-info-card .info-row i {
      width: 24px;
      color: var(--primary);
      font-size: 1.2rem;
      flex-shrink: 0;
    }

    .role-badge {
      display: inline-block;
      padding: 0.5rem 1.25rem;
      border-radius: 20px;
      font-size: 1rem;
      font-weight: 600;
      margin-bottom: 1rem;
    }

    .role-badge.admin {
      background: rgba(46, 125, 50, 0.15);
      color: var(--primary);
    }

    .role-badge.viewer {
      background: rgba(33, 150, 243, 0.15);
      color: #2196F3;
    }

    .system-info-card {
      background: var(--card-bg);
      border-radius: 20px;
      padding: 2.5rem;
      box-shadow: var(--shadow);
      display: flex;
      flex-direction: column;
      height: 100%;
      min-height: 500px;
    }

    .system-info-card h4 {
      color: var(--primary);
      margin-bottom: 2rem;
      font-size: 1.8rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .system-info-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 1.5rem;
      flex: 1;
    }

    .system-info-item {
      display: flex;
      align-items: center;
      gap: 1rem;
      padding: 1.25rem;
      background: var(--bg);
      border-radius: 12px;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .system-info-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }

    .system-info-item i {
      width: 36px;
      color: var(--primary);
      font-size: 1.6rem;
      flex-shrink: 0;
    }

    .system-info-item .info-label {
      font-size: 1rem;
      color: var(--text);
      opacity: 0.7;
      margin-bottom: 0.5rem;
    }

    .system-info-item .info-value {
      font-size: 1.3rem;
      color: var(--text);
      font-weight: 600;
    }

    .system-info-item .info-content {
      flex: 1;
    }

    .user-stats {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 1rem;
      margin-top: 1.5rem;
    }

    .stat-box {
      padding: 1rem;
      background: var(--bg);
      border-radius: 12px;
      text-align: center;
    }

    .stat-box .stat-value {
      font-size: 1.5rem;
      font-weight: bold;
      color: var(--primary);
      margin-bottom: 0.25rem;
    }

    .stat-box .stat-label {
      font-size: 0.85rem;
      color: var(--text);
      opacity: 0.7;
    }

    .settings-section {
      margin-bottom: 2rem;
    }

    .settings-section h3 {
      color: var(--primary);
      margin-bottom: 1rem;
      font-size: 1.2rem;
    }

    .setting-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem;
      background: var(--bg);
      border-radius: 12px;
      margin-bottom: 0.75rem;
    }

    .setting-item .setting-label {
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
    }

    .setting-item .setting-label span:first-child {
      font-weight: 600;
      color: var(--text);
    }

    .setting-item .setting-label span:last-child {
      font-size: 0.85rem;
      color: var(--text);
      opacity: 0.7;
    }

    .toggle-switch {
      position: relative;
      width: 50px;
      height: 26px;
      background: #ccc;
      border-radius: 13px;
      cursor: pointer;
      transition: background 0.3s;
    }

    .toggle-switch.active {
      background: var(--primary);
    }

    .toggle-switch::after {
      content: '';
      position: absolute;
      width: 20px;
      height: 20px;
      background: white;
      border-radius: 50%;
      top: 3px;
      left: 3px;
      transition: left 0.3s;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }

    .toggle-switch.active::after {
      left: 27px;
    }

    .setting-item .setting-options {
      display: flex;
      gap: 0.5rem;
      align-items: center;
    }

    .option-btn {
      padding: 0.4rem 0.8rem;
      border: 1px solid var(--primary);
      background: transparent;
      color: var(--primary);
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.85rem;
      transition: all 0.2s;
    }

    .option-btn.active {
      background: var(--primary);
      color: white;
    }

    .option-btn:hover {
      background: var(--bg);
    }

    .notification-dropdown {
      max-height: 400px;
    }

    .notification-item {
      animation: slideIn 0.3s ease;
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateX(-10px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    .system-info-card.dark-mode {
      background: #1b1f27;
    }

    .system-info-item.dark-mode {
      background: #252932;
    }

    .system-info-item.dark-mode:hover {
      background: #2a2f3a;
      box-shadow: 0 4px 8px rgba(0,0,0,0.3);
    }

    .profile-card.dark-mode, .settings-card.dark-mode, .notifications-card.dark-mode {
      background: #1b1f27;
      box-shadow: 0 4px 6px rgba(0,0,0,0.3);
    }

    .user-info-card.dark-mode {
      background: #1b1f27;
    }

    .user-info-card.dark-mode .role,
    .user-info-card.dark-mode .email,
    .user-info-card.dark-mode .phone,
    .user-info-card.dark-mode .location,
    .user-info-card.dark-mode .info-row {
      color: #e4e6eb;
    }

    .system-info-card.dark-mode h4 {
      color: #4CAF50;
    }

    .system-info-item.dark-mode .info-label,
    .system-info-item.dark-mode .info-value {
      color: #e4e6eb;
    }

    /* Notifications Page Styles */
    .notifications-list {
      max-height: calc(100vh - 200px);
      overflow-y: auto;
      padding: 1rem 0;
    }

    .notification-log-item {
      display: flex;
      align-items: flex-start;
      gap: 1rem;
      padding: 1.25rem;
      margin-bottom: 1rem;
      background: var(--bg);
      border-radius: 12px;
      border-left: 4px solid transparent;
      transition: all 0.2s;
    }

    .notification-log-item:hover {
      transform: translateX(4px);
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .notification-log-item.success {
      border-left-color: #4CAF50;
    }

    .notification-log-item.warning {
      border-left-color: #ff9800;
    }

    .notification-log-item.info {
      border-left-color: #2196F3;
    }

    .notification-log-item.error {
      border-left-color: #f44336;
    }

    .notification-log-icon {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2rem;
      flex-shrink: 0;
    }

    .notification-log-icon.success {
      background: rgba(76, 175, 80, 0.15);
      color: #4CAF50;
    }

    .notification-log-icon.warning {
      background: rgba(255, 152, 0, 0.15);
      color: #ff9800;
    }

    .notification-log-icon.info {
      background: rgba(33, 150, 243, 0.15);
      color: #2196F3;
    }

    .notification-log-icon.error {
      background: rgba(244, 67, 54, 0.15);
      color: #f44336;
    }

    .notification-log-content {
      flex: 1;
    }

    .notification-log-message {
      font-size: 1rem;
      color: var(--text);
      margin-bottom: 0.5rem;
      font-weight: 500;
    }

    .notification-log-time {
      font-size: 0.9rem;
      color: var(--text);
      opacity: 0.7;
    }

    .notification-log-item.dark-mode {
      background: #252932;
    }

    .notification-log-item.dark-mode:hover {
      background: #2a2f3a;
    }

    .stat-box.dark-mode {
      background: #252932;
    }

    .setting-item.dark-mode {
      background: #252932;
    }

    .user-info-card.dark-mode h3 {
      color: #4CAF50;
    }

    .settings-section.dark-mode h3 {
      color: #4CAF50;
    }

    .settings-card.dark-mode h2 {
      color: #4CAF50;
    }

    .setting-item.dark-mode .setting-label span:first-child {
      color: #e4e6eb;
    }

    .setting-item.dark-mode .setting-label span:last-child {
      color: #b0b3b8;
    }

    .notifications-card.dark-mode h2 {
      color: #4CAF50;
    }

    .notification-log-item.dark-mode .notification-log-message {
      color: #e4e6eb;
    }

    .notification-log-item.dark-mode .notification-log-time {
      color: #b0b3b8;
    }
  </style>
</head>
<body>
  <div class="dashboard">
    <div class="sidebar">
      <div class="sidebar-logo">
        <i class="fas fa-solar-panel"></i>
        <h2>REMS</h2>
      </div>
      <ul class="nav-menu">
        <li class="nav-item active">
          <i class="fas fa-home"></i>
          <span>Dashboard</span>
        </li>
        <li class="nav-item">
          <i class="fas fa-chart-line"></i>
          <span>Analytics</span>
        </li>
        <li class="nav-item">
          <i class="fas fa-cog"></i>
          <span>Settings</span>
        </li>
        <li class="nav-item">
          <i class="fas fa-bell"></i>
          <span>Notifications</span>
        </li>
        <li class="nav-item">
          <i class="fas fa-user"></i>
          <span>Profile</span>
        </li>
      </ul>
      <div class="status-card">
        <h4>System Status</h4>
        <div class="system-status-indicator" id="systemStatusIndicator">
          <i class="fas fa-circle"></i>
          <span id="systemStatusText">OFFLINE</span>
        </div>
        <p id="systemStatus">Waiting for data...</p>
        <p>Last updated: <span id="lastUpdate">Never</span></p>
      </div>
      <div class="system-info">
        <h4>System Info</h4>
        <p>Version: 2.1.0</p>
        <p>Last Update: Today</p>
      </div>
    </div>

    <header class="header">
      <h1>Renewable Energy Management System</h1>
      <div style="display: flex; align-items: center; gap: 1.5rem;">
        <div class="header-notification" id="headerNotification">
          <button class="notification-btn" id="notificationBell" aria-label="Notifications" type="button">
            <i class="fas fa-bell"></i>
            <span class="notification-badge" id="notificationBadge" style="display:none;">0</span>
          </button>
          <div class="notification-dropdown" id="notificationDropdown" style="display:none;">
            <div class="dropdown-header">Notifications</div>
            <div class="dropdown-alerts" id="dropdownAlerts"></div>
          </div>
        </div>
        <button id="darkModeToggle" class="action-btn" style="margin-left:1.5rem;"><i class="fas fa-moon"></i> Dark Mode</button>
      </div>
    </header>

    <main class="main-content">
      <div class="stats-grid">
        <div class="card stat-item">
          <i class="fas fa-solar-panel"></i>
          <h3>Solar Generation</h3>
          <div class="value">3.5 kW</div>
          <div class="stat-trend up">
            <i class="fas fa-arrow-up"></i>
            <span>12% vs yesterday</span>
          </div>
          <div class="comparison-matrix">Peak: 4.2 kW | Avg: 3.1 kW</div>
        </div>
        <div class="card stat-item">
          <i class="fas fa-battery-three-quarters"></i>
          <h3>Battery Level</h3>
          <div class="value">75%</div>
          <div class="stat-trend down">
            <i class="fas fa-arrow-down"></i>
            <span>5% last hour</span>
          </div>
          <div class="comparison-matrix">Capacity: 100 kWh | Health: 98%</div>
        </div>
        <div class="card stat-item">
          <i class="fas fa-bolt"></i>
          <h3>Power Usage</h3>
          <div class="value">2.8 kW</div>
          <div class="stat-trend up">
            <i class="fas fa-arrow-up"></i>
            <span>8% vs average</span>
          </div>
          <div class="comparison-matrix">Peak: 3.5 kW | Low: 1.2 kW</div>
        </div>
        <div class="card stat-item">
          <i class="fas fa-temperature-high"></i>
          <h3>System Temperature</h3>
          <div class="value">24°C</div>
          <div class="stat-trend stable">
            <i class="fas fa-equals"></i>
            <span>Stable</span>
          </div>
          <div class="comparison-matrix">Max: 28°C | Min: 20°C</div>
        </div>
      </div>

      <div class="card chart-card">
        <h3>Power Consumption Trends</h3>
        <div id="graph"></div>
        <div class="quick-actions">
          <button class="action-btn">
            <i class="fas fa-download"></i>
            Export Data
          </button>
          <button class="action-btn">
            <i class="fas fa-calendar"></i>
            Schedule Report
          </button>
          <button class="action-btn">
            <i class="fas fa-chart-line"></i>
            Detailed Analysis
          </button>
        </div>
      </div>

      <div class="card system-status">
        <h3>Energy Management Controls</h3>
        <div class="controls">
          <button class="control-btn" onclick="toggleControl('solar')" id="solarBtn">
            <i class="fas fa-sun"></i> Solar Power
            <span class="status-indicator"></span>
          </button>
          <button class="control-btn" onclick="toggleControl('battery')" id="batteryBtn">
            <i class="fas fa-battery-full"></i> Battery
            <span class="status-indicator"></span>
          </button>
          <button class="control-btn" onclick="toggleControl('grid')" id="gridBtn">
            <i class="fas fa-plug"></i> Grid Power
            <span class="status-indicator"></span>
          </button>
          <button class="control-btn" onclick="toggleAutoMode()" id="autoBtn">
            <i class="fas fa-robot"></i> Auto Mode
            <span class="status-indicator"></span>
          </button>
        </div>
        <div class="efficiency-meter">
          <h4>System Efficiency</h4>
          <div class="progress-bar">
            <div class="progress" id="efficiencyBar"></div>
            <span class="efficiency-value">0%</span>
          </div>
        </div>
        <div class="alerts" id="alertsContainer"></div>
      </div>
    </main>
  </div>

  <script>
    // Firebase Configuration - REPLACE WITH YOUR FIREBASE CONFIG
    const firebaseConfig = {
      apiKey: "AIzaSyAJmAxim4X0McfWy80W3SMwRfxK46bHZ7g",
      authDomain: "rems-dashboard.firebaseapp.com",
      databaseURL: "https://rems-dashboard-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "rems-dashboard",
      storageBucket: "rems-dashboard.firebasestorage.app",
      messagingSenderId: "89739980249",
      appId: "1:89739980249:web:7920673b22550b6d9c7dc8"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    // Global Variables
    let powerChart;
    let autoMode = true; // Auto mode ON by default
    let gridActiveStartTime = null;
    let firebaseConnected = true;
    let espOnline = false;
    let lastDataTimestamp = null;
    let dataTimeoutCheck = null;
    let currentSensorData = {};
    let currentControls = {};
    let chartData = {
      timestamps: [],
      solar: [],
      battery: [],
      consumption: []
    };

    // Monitor Firebase Connection
    function monitorConnection() {
      const connectedRef = database.ref(".info/connected");
      connectedRef.on("value", function(snap) {
        const wasConnected = firebaseConnected;
        firebaseConnected = snap.val() === true;
        
        if (!firebaseConnected && wasConnected) {
          showNotification("Firebase connection lost", "error", "firebase_disconnected");
          updateSystemStatus(false);
        } else if (firebaseConnected && !wasConnected) {
          const now = new Date();
          const timeStr = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}:${String(now.getSeconds()).padStart(2, '0')}`;
          showNotification(`[${timeStr}] Firebase connected successfully`, "success", "firebase_connected");
          // Remove disconnected alert if exists
          removeNotificationByKey('firebase_disconnected');
        }
      });
    }

    // Monitor ESP Online Status and Data Timeout
    function monitorESPStatus() {
      // Check for data timeout (> 10 seconds)
      if (dataTimeoutCheck) {
        clearInterval(dataTimeoutCheck);
      }
      
      dataTimeoutCheck = setInterval(() => {
        if (lastDataTimestamp) {
          const timeSinceLastData = Date.now() - lastDataTimestamp;
          if (timeSinceLastData > 10000) { // 10 seconds
            if (espOnline) {
              espOnline = false;
              showNotification("No data received for 10+ seconds. ESP may be offline.", "warning", "esp_timeout");
              updateSystemStatus(false);
            }
          } else {
            if (!espOnline && firebaseConnected) {
              espOnline = true;
              showNotification("ESP online - data received", "info", "esp_online");
              updateSystemStatus(true);
              removeNotificationByKey('esp_timeout');
            }
          }
        } else {
          if (espOnline) {
            espOnline = false;
            updateSystemStatus(false);
          }
        }
      }, 2000); // Check every 2 seconds
    }

    // Update System Status Indicator
    function updateSystemStatus(online) {
      const indicator = document.getElementById('systemStatusIndicator');
      const statusText = document.getElementById('systemStatusText');
      const systemStatus = document.getElementById('systemStatus');
      
      if (indicator && statusText && systemStatus) {
        if (online && firebaseConnected) {
          indicator.className = 'system-status-indicator online';
          statusText.textContent = 'ONLINE';
          systemStatus.textContent = 'All systems operational';
        } else {
          indicator.className = 'system-status-indicator offline';
          statusText.textContent = 'OFFLINE';
          systemStatus.textContent = 'System offline or no data';
        }
      }
    }

    document.addEventListener('DOMContentLoaded', function() {
      // Power Consumption Chart
      const options = {
        series: [
          { name: "Solar Generation (kWh)", data: [] },
          { name: "Battery Storage (kWh)", data: [] },
          { name: "Energy Consumption (kWh)", data: [] }
        ],
        chart: {
          type: "area",
          height: 350,
          zoom: { enabled: true },
          toolbar: { show: true, tools: { zoomin: true, zoomout: true, pan: true, reset: true } },
          animations: { enabled: true, easing: "easeout", dynamicAnimation: { speed: 600 } },
          fontFamily: 'Quicksand, sans-serif'
        },
        colors: ["var(--primary)", "var(--secondary)", "var(--tertiary)"],
        stroke: { curve: "smooth", width: 3 },
        fill: {
          type: 'gradient',
          gradient: { 
            shade: 'light', 
            gradientToColors: ['#34b3a0', '#ffcc33', '#28a745'], 
            opacityFrom: 0.5, 
            opacityTo: 0.1 
          }
        },
        xaxis: { 
          categories: [],
          labels: {
            style: {
              colors: 'var(--text)',
              fontFamily: 'Quicksand, sans-serif'
            }
          }
        },
        yaxis: {
          labels: {
            style: {
              colors: 'var(--text)',
              fontFamily: 'Quicksand, sans-serif'
            }
          }
        },
        markers: { size: 5, hover: { sizeOffset: 4 } },
        grid: { borderColor: "#ddd", strokeDashArray: 3 },
        tooltip: { 
          theme: "dark", 
          shared: true, 
          followCursor: true,
          style: {
            fontSize: '12px',
            fontFamily: 'Quicksand, sans-serif'
          }
        }
      };

      // Initialize the power consumption chart
      powerChart = new ApexCharts(document.querySelector("#graph"), options);
      powerChart.render();

      // Setup Firebase Realtime Listeners
      setupFirebaseListeners();

      // Initialize system status
      updateSystemStatus(false);

      // Initialize Solar Card Toggle
      initSolarCardToggle();

      // Initialize control buttons state (disabled if auto mode is on)
      const initialControls = { auto: true, solar: false, battery: false, grid: false };
      updateControls(initialControls);

      // Show startup notifications
      const now = new Date();
      const timeStr = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}:${String(now.getSeconds()).padStart(2, '0')}`;
      
      setTimeout(() => {
        showNotification(`[${timeStr}] System initialized`, 'info', 'startup_init');
      }, 100);

      setTimeout(() => {
        const now2 = new Date();
        const timeStr2 = `${String(now2.getHours()).padStart(2, '0')}:${String(now2.getMinutes()).padStart(2, '0')}:${String(now2.getSeconds()).padStart(2, '0')}`;
        showNotification(`[${timeStr2}] Firebase connecting...`, 'info', 'startup_firebase');
      }, 200);

      setTimeout(() => {
        const now3 = new Date();
        const timeStr3 = `${String(now3.getHours()).padStart(2, '0')}:${String(now3.getMinutes()).padStart(2, '0')}:${String(now3.getSeconds()).padStart(2, '0')}`;
        showNotification(`[${timeStr3}] Dashboard ready`, 'success', 'startup_dashboard');
      }, 500);

      // Initialize Auto Mode ON by default (after a short delay to ensure Firebase is ready)
      setTimeout(() => {
        database.ref('controls').once('value', (snapshot) => {
          const controls = snapshot.val() || {};
          if (controls.auto === null || controls.auto === undefined) {
            // Auto mode not set, initialize to true with all others false
            autoMode = true;
            database.ref('controls').set({
              auto: true,
              solar: false,
              battery: false,
              grid: false
            }).then(() => {
              // Update UI immediately after setting
              updateControls({ auto: true, solar: false, battery: false, grid: false });
            });
          } else {
            // Ensure auto mode state is correct
            autoMode = controls.auto === true;
            // Update UI with current controls state
            updateControls(controls);
          }
          const now4 = new Date();
          const timeStr4 = `${String(now4.getHours()).padStart(2, '0')}:${String(now4.getMinutes()).padStart(2, '0')}:${String(now4.getSeconds()).padStart(2, '0')}`;
          showNotification(`[${timeStr4}] Device online`, 'success', 'startup_device');
        });
      }, 1000);
    });

    // Firebase Realtime Listeners
    function setupFirebaseListeners() {
      // Listen to sensorData
      database.ref('sensorData').on('value', (snapshot) => {
        const data = snapshot.val();
        if (data) {
          currentSensorData = data;
          lastDataTimestamp = Date.now();
          
          // Mark ESP as online when data received
          if (!espOnline && firebaseConnected) {
            espOnline = true;
            showNotification("ESP online - data received", "info", "esp_online");
            updateSystemStatus(true);
          }
          
          updateCards(data);
          updateCharts(data);
          checkWarnings(data);
          // Update last update time with current timestamp
          updateLastUpdate(data.timestamp || Date.now());
          
          // Auto decision logic when sensor data changes
          if (autoMode) {
            autoDecisionLogic(data);
          }
        }
      });

      // Listen to controls
      database.ref('controls').on('value', (snapshot) => {
        const data = snapshot.val();
        if (data) {
          const previousAuto = autoMode;
          const previousControls = { ...currentControls };
          autoMode = data.auto === true;
          
          // Notify on control changes (only if changed)
          if (previousAuto !== autoMode) {
            showNotification(`Auto mode ${autoMode ? 'enabled' : 'disabled'}`, autoMode ? 'info' : 'warning', 'auto_mode_change');
          }
          
          // Track individual control changes
          if (previousControls.solar !== undefined && data.solar !== previousControls.solar) {
            showNotification(`Solar power ${data.solar ? 'enabled' : 'disabled'}`, data.solar ? 'success' : 'info', 'solar_change');
          }
          if (previousControls.battery !== undefined && data.battery !== previousControls.battery) {
            showNotification(`Battery ${data.battery ? 'enabled' : 'disabled'}`, data.battery ? 'success' : 'info', 'battery_change');
          }
          if (previousControls.grid !== undefined && data.grid !== previousControls.grid) {
            showNotification(`Grid power ${data.grid ? 'enabled' : 'disabled'}`, data.grid ? 'warning' : 'info', 'grid_change');
          }
          
          currentControls = data;
          updateControls(data);
          
          // Track grid active time
          if (data.grid === true && !gridActiveStartTime) {
            gridActiveStartTime = Date.now();
          } else if (data.grid === false) {
            gridActiveStartTime = null;
          }
        }
      });
      
      // Initialize monitoring
      monitorConnection();
      monitorESPStatus();
    }

    // Solar card toggle state
    let solarCardValue = 0.2;
    let solarCardInterval = null;

    // Initialize Solar Card Toggle
    function initSolarCardToggle() {
      if (solarCardInterval) clearInterval(solarCardInterval);
      
      const solarCard = document.querySelector('.stat-item:nth-child(1) .value');
      if (solarCard) {
        solarCard.textContent = solarCardValue.toFixed(1) + ' kWh';
      }
      
      solarCardInterval = setInterval(() => {
        solarCardValue = solarCardValue === 0.2 ? 0.3 : 0.2;
        if (solarCard) {
          solarCard.textContent = solarCardValue.toFixed(1) + ' kWh';
        }
      }, 9000); // Toggle every 9 seconds (between 8-10)
    }

    // Update Dashboard Cards
    function updateCards(data) {
      // Solar Generation - NOT from Firebase, uses toggle
      // (handled by initSolarCardToggle)

      // Battery Level - dynamic from Firebase
      const batteryValue = Math.round(data.battery || 0);
      const batteryCard = document.querySelector('.stat-item:nth-child(2) .value');
      if (batteryCard) batteryCard.textContent = batteryValue + '%';

      // Power Usage - dynamic from Firebase (voltage * current)
      const voltage = data.voltage || 0;
      const current = data.current || 0;
      const powerUsage = (voltage * current) / 1000; // Convert to kW
      const powerCard = document.querySelector('.stat-item:nth-child(3) .value');
      if (powerCard) powerCard.textContent = powerUsage.toFixed(1) + ' kW';

      // Temperature - dynamic from Firebase
      const tempValue = Math.round(data.temperature || 0);
      const tempCard = document.querySelector('.stat-item:nth-child(4) .value');
      if (tempCard) tempCard.textContent = tempValue + '°C';

      // Update Efficiency (still uses real data for calculation)
      const efficiency = calculateEfficiency(data);
      updateEfficiency(efficiency);
    }

    // Calculate Efficiency - REAL calculation from Firebase data
    function calculateEfficiency(data) {
      if (!data) return 0;
      const solar = data.solar || 0;
      const voltage = data.voltage || 0;
      const current = data.current || 0;
      const power = (voltage * current) / 1000; // Power in kW
      
      if (power === 0) return 0;
      
      // Real efficiency: (solar generation / total power consumption) * 100
      const efficiency = (solar / power) * 100;
      
      // Clamp between 0-100
      return Math.min(100, Math.max(0, Math.round(efficiency)));
    }

    // Update Efficiency Bar
    function updateEfficiency(efficiency) {
      const efficiencyBar = document.getElementById('efficiencyBar');
      const efficiencyValue = document.querySelector('.efficiency-value');
      if (efficiencyBar) efficiencyBar.style.width = `${efficiency}%`;
      if (efficiencyValue) efficiencyValue.textContent = `${efficiency}%`;
    }

    // Update Charts - uses live Firebase data
    function updateCharts(data) {
      if (!powerChart || !data) return;

      const now = new Date();
      const timeLabel = now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
      
      // Add new data point - use live Firebase data for graphs
      chartData.timestamps.push(timeLabel);
      chartData.solar.push(data.solar || 0); // Live Firebase data for graph
      chartData.battery.push((data.battery || 0) / 10); // Scale battery % to kWh range
      chartData.consumption.push(((data.voltage || 0) * (data.current || 0) / 1000));

      // Keep only last 20 data points
      if (chartData.timestamps.length > 20) {
        chartData.timestamps.shift();
        chartData.solar.shift();
        chartData.battery.shift();
        chartData.consumption.shift();
      }

      // Update chart only if we have data
      if (chartData.timestamps.length > 0) {
        try {
          powerChart.updateOptions({
            xaxis: { categories: chartData.timestamps }
          });
          powerChart.updateSeries([
            { name: "Solar Generation (kWh)", data: chartData.solar },
            { name: "Battery Storage (kWh)", data: chartData.battery },
            { name: "Energy Consumption (kWh)", data: chartData.consumption }
          ]);
        } catch (e) {
          console.error('Chart update error:', e);
        }
      }
    }

    // Update Controls UI
    function updateControls(data) {
      const controls = ['solar', 'battery', 'grid', 'auto'];
      controls.forEach(type => {
        const btn = document.getElementById(`${type}Btn`);
        if (btn) {
          const indicator = btn.querySelector('.status-indicator');
          const isActive = data[type] === true;
          
          // Active state: highlighted/glowing
          if (isActive) {
            btn.classList.add('active');
            if (indicator) indicator.classList.add('active');
          } else {
            btn.classList.remove('active');
            if (indicator) indicator.classList.remove('active');
          }

          // Disable manual buttons when auto mode is ON
          if (type !== 'auto' && autoMode) {
            btn.disabled = true;
            btn.style.cursor = 'not-allowed';
            btn.style.opacity = '0.4';
            btn.style.pointerEvents = 'none';
          } else {
            btn.disabled = false;
            btn.style.cursor = 'pointer';
            btn.style.pointerEvents = 'auto';
            // In manual mode, inactive buttons are dimmer
            if (type !== 'auto' && !autoMode && !isActive) {
              btn.style.opacity = '0.6';
            } else if (type === 'auto' || isActive) {
              btn.style.opacity = '1';
            }
          }
        }
      });
    }

    // Auto Decision Logic
    let lastAutoDecision = null;
    let autoDecisionTimeout = null;
    function autoDecisionLogic(data) {
      if (!autoMode) return;

      // Debounce auto decisions to prevent too frequent updates
      if (autoDecisionTimeout) {
        clearTimeout(autoDecisionTimeout);
      }

      autoDecisionTimeout = setTimeout(() => {
        const solar = data.solar || 0;
        const battery = data.battery || 0;
        
        let decision = {
          solar: false,
          battery: false,
          grid: false
        };

        if (solar > 2) {
          decision.solar = true;
        } else if (battery > 30) {
          decision.battery = true;
        } else {
          decision.grid = true;
        }

        // Only update if decision changed
        const decisionKey = `${decision.solar}-${decision.battery}-${decision.grid}`;
        if (lastAutoDecision !== decisionKey) {
          lastAutoDecision = decisionKey;
          decision.auto = true;
          database.ref('controls').update(decision);
        }
      }, 500); // 500ms debounce
    }

    // System Control Functions
    function toggleControl(type) {
      if (autoMode && type !== 'auto') {
        showNotification('Warning: Disable Auto Mode first', 'warning');
        return;
      }
      
      // If not auto mode and toggling solar/battery/grid, make them mutually exclusive
      if (!autoMode && type !== 'auto' && (type === 'solar' || type === 'battery' || type === 'grid')) {
        database.ref('controls').once('value', (snapshot) => {
          const current = snapshot.val() || {};
          const newValue = !current[type];
          
          // Only one source can be active at a time
          const updates = {
            solar: false,
            battery: false,
            grid: false
          };
          
          if (newValue) {
            updates[type] = true;
          }
          
          updates.auto = false; // Disable auto when manually toggling
          database.ref('controls').update(updates);
        });
        return;
      }
      
      database.ref('controls').once('value', (snapshot) => {
        const current = snapshot.val() || {};
        const newValue = !current[type];
        sendControl(type, newValue);
      });
    }

    function toggleAutoMode() {
      database.ref('controls/auto').once('value', (snapshot) => {
        const currentAuto = snapshot.val() === true;
        sendControl('auto', !currentAuto);
      });
    }

    // Send Control to Firebase
    function sendControl(type, value) {
      const updates = {};
      updates[type] = value;
      
      database.ref('controls').update(updates).then(() => {
        // If turning on auto mode, run decision logic after update
        if (type === 'auto' && value === true) {
          setTimeout(() => {
            if (currentSensorData && Object.keys(currentSensorData).length > 0) {
              autoDecisionLogic(currentSensorData);
            }
          }, 100);
        }
      }).catch((error) => {
        showNotification(`Failed to update ${type} control`, 'error', `control_error_${type}`);
      });
    }

    // Check Warnings
    function checkWarnings(data) {
      // Battery < 20%
      if (data.battery < 20) {
        showNotification(`Low battery: ${Math.round(data.battery)}%`, 'warning', 'battery_low');
      } else {
        removeNotificationByKey('battery_low');
      }

      // Temperature > 45°C
      if (data.temperature > 45) {
        showNotification(`High temperature: ${Math.round(data.temperature)}°C`, 'warning', 'temp_high');
      } else {
        removeNotificationByKey('temp_high');
      }

      // Efficiency < 50%
      const efficiency = calculateEfficiency(data);
      if (efficiency < 50 && efficiency > 0) {
        showNotification(`Low efficiency: ${efficiency}%`, 'warning', 'efficiency_low');
      } else {
        removeNotificationByKey('efficiency_low');
      }

      // Grid active too long (> 2 hours)
      if (gridActiveStartTime) {
        const gridActiveDuration = (Date.now() - gridActiveStartTime) / (1000 * 60 * 60); // hours
        if (gridActiveDuration > 2) {
          showNotification(`Grid power active for ${gridActiveDuration.toFixed(1)} hours`, 'warning', 'grid_long');
        } else {
          removeNotificationByKey('grid_long');
        }
      } else {
        removeNotificationByKey('grid_long');
      }
    }

    // Remove notification by key
    function removeNotificationByKey(key) {
      if (alertMap.has(key)) {
        const idx = alertList.findIndex(a => a.key === key);
        if (idx > -1) {
          alertList.splice(idx, 1);
          alertMap.delete(key);
          renderNotifications();
          renderNotificationsPage();
        }
      }
    }

    // Update Last Update Time - HH:MM:SS format
    function updateLastUpdate(timestamp) {
      const lastUpdateEl = document.getElementById('lastUpdate');
      if (!lastUpdateEl) return;
      
      if (timestamp) {
        const updateTime = new Date(timestamp);
        const hours = String(updateTime.getHours()).padStart(2, '0');
        const minutes = String(updateTime.getMinutes()).padStart(2, '0');
        const seconds = String(updateTime.getSeconds()).padStart(2, '0');
        lastUpdateEl.textContent = `${hours}:${minutes}:${seconds}`;
      } else {
        // Use current time if no timestamp
        const now = new Date();
        const hours = String(now.getHours()).padStart(2, '0');
        const minutes = String(now.getMinutes()).padStart(2, '0');
        const seconds = String(now.getSeconds()).padStart(2, '0');
        lastUpdateEl.textContent = `${hours}:${minutes}:${seconds}`;
      }
    }

    let alertList = [];
    const alertMap = new Map(); // Track alerts by key to avoid duplicates

    // Professional Notification System
    function getNotificationIcon(type) {
      const icons = {
        success: 'fa-check-circle',
        warning: 'fa-exclamation-triangle',
        info: 'fa-info-circle',
        error: 'fa-times-circle'
      };
      return icons[type] || 'fa-bell';
    }

    function formatTime(timestamp) {
      const time = new Date(timestamp);
      const hours = String(time.getHours()).padStart(2, '0');
      const minutes = String(time.getMinutes()).padStart(2, '0');
      const seconds = String(time.getSeconds()).padStart(2, '0');
      return `${hours}:${minutes}:${seconds}`;
    }

    function renderNotifications() {
      const dropdownAlerts = document.getElementById('dropdownAlerts');
      if (dropdownAlerts) {
        dropdownAlerts.innerHTML = '';
        if (alertList.length === 0) {
          dropdownAlerts.innerHTML = '<div style="color: #888; padding: 1rem; text-align: center;">No notifications</div>';
        } else {
          alertList.slice().reverse().forEach((alert, idx) => {
            const alertIdx = alertList.length - 1 - idx;
            const item = document.createElement('div');
            item.className = `notification-item alert ${alert.type}`;
            if (document.body.classList.contains('dark-mode')) {
              item.classList.add('dark-mode');
            }
            
            item.innerHTML = `
              <i class="fas ${getNotificationIcon(alert.type)} notification-icon"></i>
              <div class="notification-content">
                <div>${alert.message}</div>
                <div class="notification-time">${formatTime(alert.time)}</div>
              </div>
              <button class="notification-remove" data-alert-idx="${alertIdx}" title="Remove">&times;</button>
            `;
            dropdownAlerts.appendChild(item);
          });
          
          // Delete All button
          const deleteAllBtn = document.createElement('button');
          deleteAllBtn.textContent = 'Clear All';
          deleteAllBtn.className = 'delete-all-link';
          deleteAllBtn.style.cssText = 'display:block;margin:0.5rem auto 0 auto;padding:0.5rem 1rem;background:none;border:none;color:#2E7D32;text-decoration:underline;cursor:pointer;font-size:0.9rem;font-weight:600;text-align:center;border-radius:6px;transition:background 0.2s;';
          deleteAllBtn.onmouseover = function() { this.style.background = 'rgba(0,0,0,0.05)'; };
          deleteAllBtn.onmouseout = function() { this.style.background = 'none'; };
          deleteAllBtn.onclick = function(e) {
            e.stopPropagation();
            alertList = [];
            alertMap.clear();
            renderNotifications();
            renderNotificationsPage();
          };
          dropdownAlerts.appendChild(deleteAllBtn);
        }
      }
      
      // Update badge
      const badge = document.getElementById('notificationBadge');
      if (badge) {
        const warningCount = alertList.filter(a => a.type === 'warning' || a.type === 'error').length;
        if (warningCount > 0) {
          badge.textContent = warningCount;
          badge.style.display = 'inline-block';
        } else {
          badge.style.display = 'none';
        }
      }
      
      // Sidebar badge
      const sidebarItems = document.querySelectorAll('.nav-item');
      sidebarItems.forEach(item => {
        const span = item.querySelector('span');
        if (span && span.textContent.trim() === 'Notifications') {
          let sidebarBadge = item.querySelector('.sidebar-badge');
          if (!sidebarBadge) {
            sidebarBadge = document.createElement('span');
            sidebarBadge.className = 'sidebar-badge';
            sidebarBadge.style.cssText = 'position:absolute;right:1rem;background:#f44336;color:#fff;font-size:0.7rem;padding:2px 6px;border-radius:10px;min-width:18px;text-align:center;';
            item.style.position = 'relative';
            span.parentNode.appendChild(sidebarBadge);
          }
          const warningCount = alertList.filter(a => a.type === 'warning' || a.type === 'error').length;
          if (warningCount > 0) {
            sidebarBadge.textContent = warningCount;
            sidebarBadge.style.display = 'inline-block';
          } else {
            sidebarBadge.style.display = 'none';
          }
        }
      });
      
      // Add remove button listeners
      if (dropdownAlerts) {
        dropdownAlerts.querySelectorAll('.notification-remove').forEach(btn => {
          btn.addEventListener('click', function(e) {
            e.stopPropagation();
            const idx = parseInt(this.getAttribute('data-alert-idx'));
            if (!isNaN(idx) && idx < alertList.length) {
              const removed = alertList.splice(idx, 1)[0];
              if (removed && removed.key) {
                alertMap.delete(removed.key);
              }
              renderNotifications();
              renderNotificationsPage();
            }
          });
        });
      }
    }

    // Render Notifications Page
    function renderNotificationsPage() {
      const notificationsList = document.getElementById('notificationsList');
      if (!notificationsList) return;
      
      if (alertList.length === 0) {
        notificationsList.innerHTML = '<div style="text-align: center; padding: 3rem; color: var(--text); opacity: 0.7; font-size: 1.1rem;">No notifications yet</div>';
        return;
      }
      
      notificationsList.innerHTML = '';
      alertList.slice().reverse().forEach((alert) => {
        const item = document.createElement('div');
        item.className = `notification-log-item ${alert.type}`;
        if (document.body.classList.contains('dark-mode')) {
          item.classList.add('dark-mode');
        }
        
        item.innerHTML = `
          <div class="notification-log-icon ${alert.type}">
            <i class="fas ${getNotificationIcon(alert.type)}"></i>
          </div>
          <div class="notification-log-content">
            <div class="notification-log-message">${alert.message}</div>
            <div class="notification-log-time">${formatTime(alert.time)}</div>
          </div>
        `;
        notificationsList.appendChild(item);
      });
    }

    function showNotification(message, type = 'info', key = null) {
      // Add timestamp if not already present
      const now = new Date();
      const timeStr = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}:${String(now.getSeconds()).padStart(2, '0')}`;
      let finalMessage = message;
      if (!message.includes('[') || !message.match(/\[\d{2}:\d{2}:\d{2}\]/)) {
        finalMessage = `[${timeStr}] ${message}`;
      }

      // Prevent duplicates if key provided
      if (key && alertMap.has(key)) {
        // Update existing notification time
        const existing = alertList.find(a => a.key === key);
        if (existing) {
          existing.time = new Date();
          existing.message = finalMessage;
          renderNotifications();
        }
        return;
      }

      const alert = { 
        message: finalMessage, 
        type, 
        time: new Date(), 
        key: key || `${message}_${type}_${Date.now()}` 
      };
      
      alertList.push(alert);
      if (key) {
        alertMap.set(key, alert);
      }
      
      renderNotifications();
      renderNotificationsPage();
      
      // Auto-scroll dropdown to top (newest first)
      const dropdownAlerts = document.getElementById('dropdownAlerts');
      if (dropdownAlerts) {
        dropdownAlerts.scrollTop = 0;
      }
      
      // Auto-dismiss success and info messages (not warnings/errors)
      if (type === 'success' || type === 'info') {
        setTimeout(() => {
          const idx = alertList.findIndex(a => a.key === alert.key);
          if (idx > -1) {
            alertList.splice(idx, 1);
            if (key) alertMap.delete(key);
            renderNotifications();
            renderNotificationsPage();
          }
        }, 5000);
      }
      
      // Show in alerts container
      const alertsContainer = document.getElementById('alertsContainer');
      if (alertsContainer && (type === 'warning' || type === 'error')) {
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert ${type}`;
        if (document.body.classList.contains('dark-mode')) {
          alertDiv.classList.add('dark-mode');
        }
        alertDiv.innerHTML = `<i class="fas ${getNotificationIcon(type)}"></i>${finalMessage}`;
        alertsContainer.prepend(alertDiv);
        setTimeout(() => alertDiv.remove(), 8000);
      }
    }

    document.addEventListener('DOMContentLoaded', function() {
      // Notification dropdown toggle
      const bell = document.getElementById('notificationBell');
      const dropdown = document.getElementById('notificationDropdown');
      if (bell && dropdown) {
        bell.addEventListener('click', function(e) {
          e.stopPropagation();
          dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
        });
        document.addEventListener('click', function() {
          dropdown.style.display = 'none';
        });
        dropdown.addEventListener('click', function(e) {
          e.stopPropagation();
        });
      }
      renderNotifications();
    });

    // Sidebar notification click opens header dropdown
    document.addEventListener('DOMContentLoaded', function() {
      // Sidebar notification click opens header dropdown
      const sidebarItems = document.querySelectorAll('.nav-item');
      const bell = document.getElementById('notificationBell');
      const dropdown = document.getElementById('notificationDropdown');
      sidebarItems.forEach(item => {
        const span = item.querySelector('span');
        if (span && span.textContent.trim() === 'Notifications') {
          item.addEventListener('click', function(e) {
            // Open header notification dropdown
            if (dropdown && bell) {
              dropdown.style.display = 'block';
              // Optionally scroll to header if needed
              bell.focus();
            }
            e.stopPropagation();
          });
        }
      });
      renderNotifications();
    });

    // Analytics Charts Configuration
    let consumptionChart, peakUsageChart, costChart;
    const timeframeData = {
      day: {
        consumption: {
          timestamps: ['00:00', '03:00', '06:00', '09:00', '12:00', '15:00', '18:00', '21:00', '23:59'],
          consumption: [30, 25, 35, 50, 65, 60, 70, 55, 40],
          generation: [0, 0, 10, 35, 45, 50, 40, 15, 0]
        },
        peakUsage: {
          times: ["6am", "8am", "10am", "12pm", "2pm", "4pm", "6pm", "8pm", "10pm"],
          data: [44, 55, 57, 56, 61, 58, 63, 60, 45]
        },
        cost: [
          { x: 'Grid', y: 150 },
          { x: 'Solar', y: 50 },
          { x: 'Battery', y: 80 }
        ]
      },
      week: {
        consumption: {
          timestamps: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
          consumption: [250, 280, 260, 275, 290, 310, 270],
          generation: [180, 200, 190, 210, 195, 205, 185]
        },
        peakUsage: {
          times: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
          data: [65, 72, 68, 70, 75, 80, 70]
        },
        cost: [
          { x: 'Grid', y: 800 },
          { x: 'Solar', y: 400 },
          { x: 'Battery', y: 300 }
        ]
      },
      month: {
        consumption: {
          timestamps: ['Week 1', 'Week 2', 'Week 3', 'Week 4'],
          consumption: [1200, 1300, 1250, 1400],
          generation: [800, 850, 900, 875]
        },
        peakUsage: {
          times: ['Week 1', 'Week 2', 'Week 3', 'Week 4'],
          data: [85, 90, 88, 92]
        },
        cost: [
          { x: 'Grid', y: 3500 },
          { x: 'Solar', y: 1800 },
          { x: 'Battery', y: 1200 }
        ]
      },
      year: {
        consumption: {
          timestamps: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
          consumption: [4500, 4200, 4800, 5000, 5200, 5500, 5800, 5600, 5400, 5000, 4800, 4600],
          generation: [3000, 3200, 3500, 3800, 4000, 4200, 4000, 3800, 3600, 3400, 3200, 3000]
        },
        peakUsage: {
          times: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
          data: [95, 92, 98, 100, 105, 110, 115, 112, 108, 102, 98, 96]
        },
        cost: [
          { x: 'Grid', y: 42000 },
          { x: 'Solar', y: 25000 },
          { x: 'Battery', y: 15000 }
        ]
      }
    };

    function initAnalyticsCharts() {
      // Consumption Analysis Chart
      const consumptionOptions = {
        series: [{
          name: 'Total Consumption',
          data: timeframeData.day.consumption.consumption
        }, {
          name: 'Solar Generation',
          data: timeframeData.day.consumption.generation
        }],
        chart: {
          height: 350,
          type: 'line',
          zoom: { enabled: true },
          fontFamily: 'Quicksand, sans-serif',
          toolbar: {
            show: true,
            offsetX: 0,
            offsetY: 0,
            tools: {
              download: true,
              selection: true,
              zoom: true,
              zoomin: true,
              zoomout: true,
              pan: true,
              reset: true
            },
            export: {
              svg: {
                filename: 'energy-consumption-svg',
              },
              csv: {
                filename: 'energy-consumption-data',
              },
              png: {
                filename: 'energy-consumption-png',
              }
            },
            autoSelected: 'zoom'
          }
        },
        dataLabels: { enabled: false },
        stroke: {
          width: [3, 3],
          curve: 'smooth',
          dashArray: [0, 5]
        },
        colors: ['var(--primary)', 'var(--secondary)'],
        markers: {
          size: 4,
          colors: ['var(--primary)', 'var(--secondary)'],
          strokeColors: '#fff',
          strokeWidth: 2,
          hover: { size: 7 }
        },
        xaxis: {
          categories: timeframeData.day.consumption.timestamps,
          labels: {
            style: { colors: 'var(--text)', fontFamily: 'Quicksand, sans-serif' }
          }
        },
        yaxis: {
          title: {
            text: 'Energy (kWh)',
            style: { fontFamily: 'Quicksand, sans-serif' }
          },
          labels: {
            style: { colors: 'var(--text)', fontFamily: 'Quicksand, sans-serif' }
          }
        },
        grid: { borderColor: '#e0e0e0', strokeDashArray: 5 },
        legend: { 
          position: 'top', 
          horizontalAlign: 'left',
          offsetX: 40,
          offsetY: 8,
          itemMargin: {
            horizontal: 12
          }
        },
        tooltip: { 
          theme: 'dark',
          y: {
            formatter: function(value) {
              return value + " kWh";
            }
          }
        }
      };

      // Peak Usage Chart
      const peakUsageOptions = {
        series: [{
          name: 'Peak Usage',
          data: timeframeData.day.peakUsage.data
        }],
        chart: {
          type: 'bar',
          height: 350,
          fontFamily: 'Quicksand, sans-serif',
          toolbar: { show: true }
        },
        plotOptions: {
          bar: {
            borderRadius: 10,
            columnWidth: '60%',
            dataLabels: { position: 'top' }
          }
        },
        dataLabels: {
          enabled: true,
          formatter: function (val) {
            return val + " kW";
          },
          offsetY: -20,
          style: {
            fontSize: '12px',
            colors: ['var(--text)'],
            fontFamily: 'Quicksand, sans-serif'
          }
        },
        colors: ['var(--gradient-start)'],
        xaxis: {
          categories: timeframeData.day.peakUsage.times,
          position: 'bottom',
          labels: {
            style: { colors: 'var(--text)', fontFamily: 'Quicksand, sans-serif' }
          },
          axisBorder: { show: false },
          axisTicks: { show: false }
        },
        yaxis: {
          title: {
            text: 'Power (kW)',
            style: { fontFamily: 'Quicksand, sans-serif' }
          },
          axisBorder: { show: false },
          axisTicks: { show: false },
          labels: {
            show: true,
            formatter: function (val) {
              return val.toFixed(0) + " kW";
            },
            style: { colors: 'var(--text)', fontFamily: 'Quicksand, sans-serif' }
          }
        }
      };

      // Cost Analysis Chart
      const costOptions = {
        series: timeframeData.day.cost.map(item => item.y),
        chart: {
          type: 'pie',
          height: 350,
          fontFamily: 'Quicksand, sans-serif'
        },
        labels: ['Grid Power', 'Solar Power', 'Battery Storage'],
        colors: ['var(--gradient-start)', 'var(--gradient-mid)', 'var(--gradient-end)'],
        legend: {
          position: 'bottom',
          fontFamily: 'Quicksand, sans-serif'
        },
        dataLabels: {
          enabled: true,
          formatter: function (val) {
            return val.toFixed(1) + "%";
          },
          style: {
            fontSize: '14px',
            fontFamily: 'Quicksand, sans-serif',
            fontWeight: 'bold'
          }
        },
        tooltip: {
          y: {
            formatter: function(value) {
              return "$" + value.toFixed(2);
            }
          }
        },
        responsive: [{
          breakpoint: 480,
          options: {
            chart: { height: 300 },
            legend: { position: 'bottom' }
          }
        }]
      };

      // Initialize Charts
      consumptionChart = new ApexCharts(document.querySelector("#consumptionChart"), consumptionOptions);
      peakUsageChart = new ApexCharts(document.querySelector("#peakUsageChart"), peakUsageOptions);
      costChart = new ApexCharts(document.querySelector("#costChart"), costOptions);

      consumptionChart.render();
      peakUsageChart.render();
      costChart.render();
    }

    // Time filter handling
    function updateTimeframe(timeframe) {
      const buttons = document.querySelectorAll('.time-filter button');
      buttons.forEach(btn => btn.classList.remove('active'));
      event.target.classList.add('active');
      
      const data = timeframeData[timeframe];
      
      // Update Consumption Chart
      consumptionChart.updateOptions({
        xaxis: {
          categories: data.consumption.timestamps
        }
      });
      consumptionChart.updateSeries([
        {
          name: 'Total Consumption',
          data: data.consumption.consumption
        },
        {
          name: 'Solar Generation',
          data: data.consumption.generation
        }
      ]);

      // Update Peak Usage Chart
      peakUsageChart.updateOptions({
        xaxis: {
          categories: data.peakUsage.times
        }
      });
      peakUsageChart.updateSeries([{
        name: 'Peak Usage',
        data: data.peakUsage.data
      }]);

      // Update Cost Chart
      costChart.updateSeries(data.cost.map(item => item.y));
      
      showNotification(`Showing ${timeframe} analytics data`, 'success');
    }

    // Premium Dark Mode Toggle
    const darkModeBtn = document.getElementById('darkModeToggle');
    function setDarkMode(active) {
      document.body.classList.toggle('dark-mode', active);
      
      // Apply dark mode to all elements
      const elementsToToggle = document.querySelectorAll('.dashboard, .sidebar, .header, .main-content, .card, .system-status, .chart-card, .status-card, .analytics-card, .nav-item, .stat-item, .quick-actions, .efficiency-meter, .progress-bar, .alert, .notification-dropdown, .dropdown-header, .control-btn, .action-btn, .notification-item, .profile-card, .settings-card, .stat-box, .setting-item, .user-info-card, .system-info');
      elementsToToggle.forEach(el => {
        if (el) el.classList.toggle('dark-mode', active);
      });
      
      // Update settings toggle if exists
      const settingsDarkMode = document.getElementById('settingsDarkMode');
      if (settingsDarkMode) {
        settingsDarkMode.classList.toggle('active', active);
      }
      
      // Update chart colors for dark mode
      if (powerChart) {
        const isDark = document.body.classList.contains('dark-mode');
        powerChart.updateOptions({
          theme: { mode: isDark ? 'dark' : 'light' },
          xaxis: {
            labels: {
              style: {
                colors: isDark ? '#e4e6eb' : '#333333'
              }
            }
          },
          yaxis: {
            labels: {
              style: {
                colors: isDark ? '#e4e6eb' : '#333333'
              }
            }
          }
        });
      }
      
      // Change icon and text
      if (darkModeBtn) {
        if (active) {
          darkModeBtn.innerHTML = '<i class="fas fa-sun"></i> Light Mode';
        } else {
          darkModeBtn.innerHTML = '<i class="fas fa-moon"></i> Dark Mode';
        }
      }
      
      // Re-render notifications to apply dark mode
      renderNotifications();
    }
    
    // Persist dark mode state
    if (localStorage.getItem('darkMode') === 'true') {
      setDarkMode(true);
    }
    
    if (darkModeBtn) {
      darkModeBtn.addEventListener('click', function() {
        const isDark = !document.body.classList.contains('dark-mode');
        setDarkMode(isDark);
        localStorage.setItem('darkMode', isDark);
      });
    }

    // Add navigation handling
    document.addEventListener('DOMContentLoaded', function() {
      const mainContent = document.querySelector('.main-content');
      
      // Check if analyticsContent already exists to avoid duplicates
      let analyticsContent = document.querySelector('.analytics-content');
      if (!analyticsContent) {
        analyticsContent = document.createElement('div');
        analyticsContent.className = 'analytics-content';
        analyticsContent.innerHTML = `
          <div class="analytics-card full-width">
            <div class="analytics-header">
              <h3>Energy Consumption Analysis</h3>
              <div class="time-filter">
                <button class="active" onclick="updateTimeframe('day')">Day</button>
                <button onclick="updateTimeframe('week')">Week</button>
                <button onclick="updateTimeframe('month')">Month</button>
                <button onclick="updateTimeframe('year')">Year</button>
              </div>
            </div>
            <div id="consumptionChart"></div>
            <div class="quick-actions" style="margin-top: 1rem; padding: 1rem; justify-content: flex-start; gap: 1rem;">
              <button class="action-btn">
                <i class="fas fa-download"></i>
                Export Data
              </button>
              <button class="action-btn">
                <i class="fas fa-calendar"></i>
                Schedule Report
              </button>
              <button class="action-btn">
                <i class="fas fa-chart-line"></i>
                Detailed Analysis
              </button>
            </div>
          </div>
          <div class="analytics-card">
            <h3>Peak Usage Hours</h3>
            <div id="peakUsageChart"></div>
          </div>
          <div class="analytics-card">
            <h3>Cost Analysis</h3>
            <div id="costChart"></div>
          </div>
        `;
        mainContent.parentNode.insertBefore(analyticsContent, mainContent.nextSibling);
      }

      // Create Profile Content
      let profileContent = document.querySelector('.profile-content');
      if (!profileContent) {
        profileContent = document.createElement('div');
        profileContent.className = 'profile-content';
        profileContent.innerHTML = `
          <div class="profile-card user-info-card">
            <div class="user-avatar">
              <i class="fas fa-user"></i>
            </div>
            <h3>Viral Patel</h3>
            <div class="role-badge admin">Admin</div>
            <div class="role">Home Owner / System Admin</div>
            <div class="email">viral@rems.home</div>
            <div class="phone">+91 9898738696</div>
            <div class="location">Vadodara, Gujarat</div>
            <div class="info-row">
              <i class="fas fa-shield-alt"></i>
              <span>System Role: Full Access</span>
            </div>
            <div class="info-row">
              <i class="fas fa-bolt"></i>
              <span>Energy Plan: Solar + Battery + Grid Hybrid</span>
            </div>
            <div class="info-row">
              <i class="fas fa-calendar"></i>
              <span>Installation Date: Jan 2026</span>
            </div>
          </div>
          <div class="profile-card user-info-card">
            <div class="user-avatar" style="background: linear-gradient(135deg, #e91e63, #f06292);">
              <i class="fas fa-user"></i>
            </div>
            <h3>Hena Patel</h3>
            <div class="role-badge viewer">Viewer</div>
            <div class="role">Family Member / Viewer</div>
            <div class="email">hena@rems.home</div>
            <div class="info-row">
              <i class="fas fa-eye"></i>
              <span>Access Level: Monitoring Only</span>
            </div>
            <div class="info-row">
              <i class="fas fa-key"></i>
              <span>Permissions: View stats + alerts only</span>
            </div>
          </div>
          <div class="system-info-card">
            <h4><i class="fas fa-info-circle"></i> System Information</h4>
            <div class="system-info-grid">
              <div class="system-info-item">
                <i class="fas fa-home"></i>
                <div class="info-content">
                  <div class="info-label">House Type</div>
                  <div class="info-value">3BHK Residential</div>
                </div>
              </div>
              <div class="system-info-item">
                <i class="fas fa-solar-panel"></i>
                <div class="info-content">
                  <div class="info-label">Solar Capacity</div>
                  <div class="info-value">3 kW</div>
                </div>
              </div>
              <div class="system-info-item">
                <i class="fas fa-battery-full"></i>
                <div class="info-content">
                  <div class="info-label">Battery Type</div>
                  <div class="info-value">LiFePO4</div>
                </div>
              </div>
              <div class="system-info-item">
                <i class="fas fa-battery-three-quarters"></i>
                <div class="info-content">
                  <div class="info-label">Battery Capacity</div>
                  <div class="info-value">5 kWh</div>
                </div>
              </div>
              <div class="system-info-item">
                <i class="fas fa-plug"></i>
                <div class="info-content">
                  <div class="info-label">Grid Provider</div>
                  <div class="info-value">PGVCL</div>
                </div>
              </div>
              <div class="system-info-item">
                <i class="fas fa-id-card"></i>
                <div class="info-content">
                  <div class="info-label">Installation ID</div>
                  <div class="info-value">REMS-001</div>
                </div>
              </div>
            </div>
          </div>
        `;
        mainContent.parentNode.insertBefore(profileContent, mainContent.nextSibling);
      }

      // Create Notifications Content
      let notificationsContent = document.querySelector('.notifications-content');
      if (!notificationsContent) {
        notificationsContent = document.createElement('div');
        notificationsContent.className = 'notifications-content';
        notificationsContent.innerHTML = `
          <div class="notifications-card full-width">
            <h2 style="color: var(--primary); margin-bottom: 2rem; font-size: 2rem; font-weight: 600;">
              <i class="fas fa-bell"></i> System Logs & Notifications
            </h2>
            <div class="notifications-list" id="notificationsList">
              <div style="text-align: center; padding: 2rem; color: var(--text); opacity: 0.7;">
                Loading notifications...
              </div>
            </div>
          </div>
        `;
        mainContent.parentNode.insertBefore(notificationsContent, mainContent.nextSibling);
      }

      // Create Settings Content
      let settingsContent = document.querySelector('.settings-content');
      if (!settingsContent) {
        settingsContent = document.createElement('div');
        settingsContent.className = 'settings-content';
        settingsContent.innerHTML = `
          <div class="settings-card full-width">
            <h2 style="color: var(--primary); margin-bottom: 2rem;">Settings</h2>
            
            <div class="settings-section">
              <h3>Appearance</h3>
              <div class="setting-item">
                <div class="setting-label">
                  <span>Dark Mode</span>
                  <span>Toggle dark theme for better viewing in low light</span>
                </div>
                <div class="toggle-switch" id="settingsDarkMode"></div>
              </div>
            </div>

            <div class="settings-section">
              <h3>Notifications</h3>
              <div class="setting-item">
                <div class="setting-label">
                  <span>Enable Notifications</span>
                  <span>Receive alerts for system events and warnings</span>
                </div>
                <div class="toggle-switch active" id="settingsNotifications"></div>
              </div>
            </div>

            <div class="settings-section">
              <h3>System</h3>
              <div class="setting-item">
                <div class="setting-label">
                  <span>Auto Mode Default</span>
                  <span>Enable auto mode by default on system startup</span>
                </div>
                <div class="toggle-switch active" id="settingsAutoMode"></div>
              </div>
            </div>

            <div class="settings-section">
              <h3>Display</h3>
              <div class="setting-item">
                <div class="setting-label">
                  <span>Temperature Unit</span>
                  <span>Choose between Celsius and Fahrenheit</span>
                </div>
                <div class="setting-options">
                  <button class="option-btn active" data-unit="celsius">°C</button>
                  <button class="option-btn" data-unit="fahrenheit">°F</button>
                </div>
              </div>
            </div>

            <div class="settings-section">
              <h3>Data Refresh</h3>
              <div class="setting-item">
                <div class="setting-label">
                  <span>Refresh Rate</span>
                  <span>How often to update sensor data</span>
                </div>
                <div class="setting-options">
                  <button class="option-btn" data-rate="1">1s</button>
                  <button class="option-btn active" data-rate="2">2s</button>
                  <button class="option-btn" data-rate="5">5s</button>
                </div>
              </div>
            </div>
          </div>
        `;
        mainContent.parentNode.insertBefore(settingsContent, mainContent.nextSibling);
      }

      // Initialize Settings Toggles
      const settingsDarkMode = document.getElementById('settingsDarkMode');
      const settingsNotifications = document.getElementById('settingsNotifications');
      const settingsAutoMode = document.getElementById('settingsAutoMode');

      if (settingsDarkMode) {
        if (localStorage.getItem('darkMode') === 'true') {
          settingsDarkMode.classList.add('active');
        }
        settingsDarkMode.addEventListener('click', function() {
          this.classList.toggle('active');
          const isDark = this.classList.contains('active');
          setDarkMode(isDark);
          localStorage.setItem('darkMode', isDark);
        });
      }

      if (settingsNotifications) {
        const notificationsEnabled = localStorage.getItem('notificationsEnabled') !== 'false';
        if (notificationsEnabled) {
          settingsNotifications.classList.add('active');
        }
        settingsNotifications.addEventListener('click', function() {
          this.classList.toggle('active');
          const enabled = this.classList.contains('active');
          localStorage.setItem('notificationsEnabled', enabled);
        });
      }

      if (settingsAutoMode) {
        const autoModeDefault = localStorage.getItem('autoModeDefault') !== 'false';
        if (autoModeDefault) {
          settingsAutoMode.classList.add('active');
        }
        settingsAutoMode.addEventListener('click', function() {
          this.classList.toggle('active');
          const enabled = this.classList.contains('active');
          localStorage.setItem('autoModeDefault', enabled);
        });
      }

      // Temperature Unit Toggle
      const tempUnitButtons = settingsContent.querySelectorAll('[data-unit]');
      const savedTempUnit = localStorage.getItem('tempUnit') || 'celsius';
      tempUnitButtons.forEach(btn => {
        if (btn.getAttribute('data-unit') === savedTempUnit) {
          btn.classList.add('active');
        }
        btn.addEventListener('click', function() {
          tempUnitButtons.forEach(b => b.classList.remove('active'));
          this.classList.add('active');
          localStorage.setItem('tempUnit', this.getAttribute('data-unit'));
        });
      });

      // Data Refresh Rate Toggle
      const refreshRateButtons = settingsContent.querySelectorAll('[data-rate]');
      const savedRefreshRate = localStorage.getItem('refreshRate') || '2';
      refreshRateButtons.forEach(btn => {
        if (btn.getAttribute('data-rate') === savedRefreshRate) {
          btn.classList.add('active');
        }
        btn.addEventListener('click', function() {
          refreshRateButtons.forEach(b => b.classList.remove('active'));
          this.classList.add('active');
          localStorage.setItem('refreshRate', this.getAttribute('data-rate'));
        });
      });

      // Initialize Analytics Charts
      if (typeof initAnalyticsCharts === 'function') {
        initAnalyticsCharts();
      }

      // Handle navigation
      const navItems = document.querySelectorAll('.nav-item');
      navItems.forEach(item => {
        item.addEventListener('click', function() {
          const pageName = this.querySelector('span').textContent;
          navItems.forEach(i => i.classList.remove('active'));
          this.classList.add('active');
          
          // Hide all content
          mainContent.style.display = 'none';
          analyticsContent.classList.remove('active');
          profileContent.classList.remove('active');
          settingsContent.classList.remove('active');
          notificationsContent.classList.remove('active');
          
          // Show selected page
          if (pageName === 'Dashboard') {
            mainContent.style.display = 'grid';
          } else if (pageName === 'Analytics') {
            analyticsContent.classList.add('active');
            window.dispatchEvent(new Event('resize'));
          } else if (pageName === 'Profile') {
            profileContent.classList.add('active');
          } else if (pageName === 'Settings') {
            settingsContent.classList.add('active');
          } else if (pageName === 'Notifications') {
            notificationsContent.classList.add('active');
            renderNotificationsPage();
          }
        });
      });

      // Apply dark mode to new elements
      if (document.body.classList.contains('dark-mode')) {
        [analyticsContent, profileContent, settingsContent, notificationsContent].forEach(content => {
          if (content) {
            content.querySelectorAll('.analytics-card, .profile-card, .settings-card, .notifications-card, .stat-box, .setting-item, .system-info-card, .system-info-item, .notification-log-item').forEach(el => {
              el.classList.add('dark-mode');
            });
          }
        });
      }
    });
  </script>
</body>
</html>
